"use strict";var $DT2017=$DT2017||{};$DT2017.bookEdit=function(){var e={selectedBookList:[],selectedBookCase:null,isBookEditMode:!1,onBookEditMode:function(e){var t,o,a,s=this;switch(this.isBookEditMode=!0,$DT2017.core.currentListType){case"image":t=".bookThumbnailBox",o=".bookDetailButton",a=".bookThumbnailImage";break;case"list":t=".bookThumbnailBoxForListType",o=".bookDetailButtonForListType",a=".bookThumbnailImageForListType"}var i=$alt.qsa(t);this.appendHeaderMenu({targetElement:$alt.qs(".topMenubarContainer"),mode:e.mode});for(var n=0;n<i.length;n++){var l=i[n].querySelector(o);l.style.opacity=0;var c=JSON.parse(l.getAttribute("bookData")),r=i[n].querySelector(a),d=$alt.ce({tag:"div","class":"comboBoxElement",targetElement:i[n]});if(d.style.width=r.width+"px",d.style.height=r.height+"px","list"===$DT2017.core.currentListType&&(d.style.top="27px"),d.setAttribute("selectBookData",JSON.stringify({bookId:c.bookId,extractPath:c.extractPath,type:c.type})),d.setAttribute("isSelected",!1),d.addEventListener("click",function(t){t.preventDefault(),"wedorang"===e.mode&&s.unselectAllElement({targetElement:$alt.qsa(".comboBoxElement")});var o=this.getAttribute("isSelected"),a=JSON.parse(this.getAttribute("selectBookData"));if("false"===o)this.style.backgroundImage="url(./images/view/view_SelectedIcon_on.png)",this.setAttribute("isSelected",!0),s.selectedBookList.push({bookId:a.bookId,extractPath:a.extractPath});else{this.style.backgroundImage="url(./images/view/view_SelectedIcon_off.png)",this.setAttribute("isSelected",!1);for(var i=0;i<s.selectedBookList.length;i++)s.selectedBookList[i].bookId.trim()===a.bookId.trim()&&s.selectedBookList.splice(i,1)}console.log(s.selectedBookList)},!1),"wedorang"===e.mode)switch(c.type.toLowerCase().trim()){case"pdf":case"note":break;default:d.style.pointerEvents="none",d.style.opacity=0;var k=$alt.ce({tag:"div","class":"barrierElement",targetElement:i[n]});k.style.width=d.style.width,k.style.height=d.style.height}if("moveStorage"===e.mode&&c.isSaveSDCard){var u,m;switch($DT2017.core.currentListType){case"image":u=0,m=i[n];break;case"list":u="40px",m=i[n].querySelector(".bookThumbnailContainer")}switch(c.isSaveSDCard.toLowerCase().trim()){case"yes":var g=$alt.ce({tag:"div","class":"storageIcon_SD",html:"외장<br>메모리",targetElement:m});g.style.top=u;break;case"no":var h=$alt.ce({tag:"div","class":"storageIcon_IN",html:"내장<br>메모리",targetElement:m});h.style.top=u}}}},appendHeaderMenu:function(e){var t=this,o=$alt.ce({tag:"div",id:"comboBoxSelectMenu","class":"moreMenuBackground",targetElement:e.targetElement});switch(o.style.display="block",o.style.zIndex=20,o.style.height="95px",e.mode){case"moveDelete":var a=$alt.ce({tag:"div","class":"bookEditMoveButton",html:"이동",targetElement:o});a.addEventListener("click",function(e){e.preventDefault(),t.processHeaderEditing({mode:"move"})},!1);var s=$alt.ce({tag:"div","class":"bookEditDeleteButton",html:"삭제",targetElement:o});s.addEventListener("click",function(e){e.preventDefault(),t.processHeaderEditing({mode:"delete"})},!1);break;case"wedorang":var i=$alt.ce({tag:"div","class":"sendWedorangButton",html:"위두랑 전송",targetElement:o});i.addEventListener("click",function(e){e.preventDefault(),t.selectedBookList.length>0?($DT2017.apiBridge.openWedorangSendClass({bookId:t.selectedBookList[0].bookId}),t.cancelBookEdit({targetElement:o})):$DT2017.notice.show({noticeText:"위두랑에 전송 할 컨텐츠를 선택하세요!",buttonText:"확 인",clickEvent:function(){$DT2017.notice.hide()}})},!1);break;case"moveStorage":var n=$alt.ce({tag:"div","class":"sendWedorangButton",html:"저장위치 변경",targetElement:o});n.addEventListener("click",function(e){e.preventDefault(),t.selectedBookList.length>0?($DT2017.loading.show({opacity:.5,showLoadingIcon:!0}),$DT2017.apiBridge.moveStorageContentsList(t.selectedBookList),t.cancelBookEdit({targetElement:o})):$DT2017.notice.show({noticeText:"저장위치를 변경 할 컨텐츠를 선택하세요!",buttonText:"확 인",clickEvent:function(){$DT2017.notice.hide()}})},!1)}var l=$alt.ce({tag:"div","class":"bookEditCancelButton",html:"취소",targetElement:o});l.addEventListener("click",function(e){e.preventDefault(),t.cancelBookEdit({targetElement:o})},!1)},processHeaderEditing:function(e){var t,o,a,s,i=this,n=function(e){e.style.color="#f26422",e.style.fontWeight="900",i.selectedBookCase=e.innerHTML};switch(e.mode){case"delete":t="삭제 할 컨텐츠를 선택하세요.",o="<p>선택한 책을 내 서재에서 삭제하시겠습니까? </p> <p>책에 기록한 모든 데이터도 함께 삭제됩니다.</p><p>삭제된 책과 데이터는 복구되지 않습니다.</p>",a="책 삭제";break;case"move":i.selectedBookCase=null,t="이동 할 컨텐츠를 선택하세요.",a='<img class="importFileIcon" src="./images/subMenu/importFileIcon.png">이동할 책장 선택',s=function(e){var t=$alt.ce({tag:"div","class":"bookShelfBox",targetElement:e});$DT2017.responsive.screenSize.width<$DT2017.responsive.responsivePoint.responsivePointMobile?t.style.height="185px":t.style.height="280px",$DT2017.core.bookCaseList.forEach(function(e,o){var a=$alt.ce({tag:"div","class":"bookCaseListElement",html:e.name,targetElement:t});a.addEventListener("click",function(e){e.preventDefault();for(var t=$alt.qsa(".bookCaseListElement"),o=0;o<t.length;o++)t[o].style.color="#555",t[o].style.fontWeight="100";n(this),console.log(i.selectedBookCase)},!1)})}}if(i.selectedBookList.length<1)$DT2017.notice.show({noticeText:t,buttonText:"확 인",clickEvent:function(){console.log("> clickEvent!"),$DT2017.notice.hide()}});else switch(e.mode){case"delete":$DT2017.notice.show({type:"confirm",title:a,noticeText:o,buttonText:"확 인",clickEvent:function(){console.log("> clickEvent!"),$DT2017.loading.show({opacity:.5,showLoadingIcon:!0}),i.deletBookProcess("no"),$DT2017.notice.hide()},noButtonText:"취소",noButtonEvent:function(){$DT2017.notice.hide()},centerButtonText:"사용자데이터 <br>저장 후 삭제",centerButtonEvent:function(){console.log("> centerButtonEvent!"),$DT2017.loading.show({opacity:.5,showLoadingIcon:!0}),i.deletBookProcess("yes"),$DT2017.notice.hide()}});break;case"move":$DT2017.layerPop.show({title:a,noticeText:o,buttonText:"확 인",yesButtonEvent:function(){return console.log("> clickEvent!"),null===i.selectedBookCase?void $DT2017.notice.show({noticeText:"이동할 책장을 선택하세요!",buttonText:"확 인",clickEvent:function(){console.log("> clickEvent!"),$DT2017.notice.hide()}}):(i.moveBookProcess(),void $DT2017.layerPop.hide())},noButtonText:"취소",noButtonEvent:function(){$DT2017.layerPop.hide()},callBack:s})}},cancelBookEdit:function(e){e.targetElement.parentNode.removeChild(e.targetElement),this.isBookEditMode=!1;var t,o,a;switch($DT2017.core.currentListType){case"image":t=".bookThumbnailBox",o=".bookThumbnailImage",a=".bookDetailButton";break;case"list":t=".bookThumbnailBoxForListType",o=".bookThumbnailImageForListType",a=".bookDetailButtonForListType"}for(var s=$alt.qsa(t),i=0;i<s.length;i++){var n=s[i].querySelector(a),l=JSON.parse(s[i].querySelector(o).getAttribute("bookData"));"dtpcontents"===l.type.toLowerCase().trim()&&(n.style.opacity=1);var c=s[i].querySelector(".comboBoxElement");c&&s[i].removeChild(c);var r,d;switch($DT2017.core.currentListType){case"image":r=s[i].querySelector(".storageIcon_SD"),r&&s[i].removeChild(r),d=s[i].querySelector(".storageIcon_IN"),d&&s[i].removeChild(d);break;case"list":var k=s[i].querySelector(".bookThumbnailContainer");r=k.querySelector(".storageIcon_SD"),r&&k.removeChild(r),d=k.querySelector(".storageIcon_IN"),d&&k.removeChild(d)}}this.selectedBookList=[],this.removeBarrierElement()},deletBookProcess:function(e){console.log("%c ▶▷ [Native API] deleteBook ","color:#ff6600");var t={apiName:"deleteBook",parameters:{deleteBookList:this.selectedBookList,isSaveAnnotation:e},callBack:"deleteBookCallBack"};window[t.callBack]=function(e){$DT2017.view.refresh({response:e}),$DT2017.bookEdit.cancelBookEdit({targetElement:$alt.qs("#comboBoxSelectMenu")}),$DT2017.loading.hide(),delete window[t.callBack]},$DT2017.apiBridge.sendMessageToNative(t.apiName,JSON.stringify(t));var o={response:{DtextBook:{BookList:{bookItem:[{contentsSeq:"",epubItem:[{coverImage:"C:/Users/polarxp/AppData/Local/DigitalTextbookPlus/DtextBook/577f01ca-949e-647e-9385-84a5e990d444/lesson01.epub/ops/coverimage/cover.png",creator:"",downloadUrl:"",epubItemId:"book_001",extractPath:"C:/Users/polarxp/AppData/Local/DigitalTextbookPlus/DtextBook/577f01ca-949e-647e-9385-84a5e990d444/lesson01.epub/",isDownload:"yes",isUpdate:"no",packagingDate:"2017-06-27T07:52:15Z",producer:"",publisher:"",rightsHolder:"",startPageNumber:"1",subBookId:"urn:uuid:892d15cd-bda2-6d98-9386-b32169b90505",title:" lesson01 "},{coverImage:"C:/Users/polarxp/AppData/Local/DigitalTextbookPlus/DtextBook/577f01ca-949e-647e-9385-84a5e990d444/lesson02.epub/ops/coverimage/cover.jpg",creator:"",downloadUrl:"",epubItemId:"book_002",extractPath:"C:/Users/polarxp/AppData/Local/DigitalTextbookPlus/DtextBook/577f01ca-949e-647e-9385-84a5e990d444/lesson02.epub/",isDownload:"yes",isUpdate:"no",packagingDate:"2017-06-27T07:55:29Z",producer:"",publisher:"",rightsHolder:"",startPageNumber:"19",subBookId:"urn:uuid:3199102c-94c4-629e-b573-c8ebe613f371",title:" lesson02 "}],extractPath:"C:/Users/polarxp/AppData/Local/DigitalTextbookPlus/DtextBook/577f01ca-949e-647e-9385-84a5e990d444/",fullBookId:"furn:uuid:577f01ca-949e-647e-9385-84a5e990d444",isDownload:"yes",isUpdate:"no",metadata:{courseName:"°úÇÐ/±â¼ú¡¤°¡Á¤/Á¤º¸",coverImage:"",creator:"",date:"2017-06-27T00:00:00Z",description:"",gradeGroup:"ÁßÇÐ±³",producer:"",publisher:"tovtest",rightsHolder:"",schoolGrade:"ÅëÇÕ",subject:"",term:"",title:"°úÇÐ¨ç"},packagingDate:"2017-06-27T07:57:15Z",type:"DTPCONTENTS"}]}},UserData:{BookList:{bookItem:[]},BookShelf:{shelfItem:[{bookRef:[{bookId:"furn:uuid:577f01ca-949e-647e-9385-84a5e990d444"}],isDefaultShelf:"yes",name:"±âº» Ã¥Àå"}]}}}};setTimeout(function(){window[t.callBack](o)},1e3)},moveBookProcess:function(){console.log("- bookCaseList: ",$DT2017.core.bookCaseList),console.log("- selectedBookList: ",this.selectedBookList),console.log("- bookCaseName: ",this.selectedBookCase);for(var e=0;e<this.selectedBookList.length;e++)this.removeBookCaseItem(this.selectedBookList[e].bookId);this.insertBookCaseItem(this.selectedBookCase),console.log("- result bookCaseList: ",$DT2017.core.bookCaseList),this.cancelBookEdit({targetElement:$alt.qs("#comboBoxSelectMenu")}),this.refreshBookCase($DT2017.bookCase.currentBookCase),this.updateBookCase(),$DT2017.bookCase.currentBookCaseIndex=0,$DT2017.view.reload()},removeBookCaseItem:function(e){$DT2017.core.bookCaseList.forEach(function(t,o){var a=t.bookRef.filter(function(t,o){return t.bookId.trim()!==e.trim()});t.bookRef=a})},insertBookCaseItem:function(e){$DT2017.core.bookCaseList.forEach(function(t,o){if(t.name.trim()===e.trim())for(var a=0;a<$DT2017.bookEdit.selectedBookList.length;a++)t.bookRef.push({bookId:$DT2017.bookEdit.selectedBookList[a].bookId})})},refreshBookCase:function(e){$DT2017.core.bookCaseList.forEach(function(t,o){t.name.trim()===e.trim()&&$DT2017.bookCase.selectBookCaseName(t)})},updateBookCase:function(){console.log("%c ▶▷ [Native API] updateBookShelf ","color:#ff6600");var e={apiName:"updateBookShelf",parameters:{BookShelf:{shelfItem:$DT2017.core.bookCaseList}},callBack:"updateBookShelfCallBack"};window[e.callBack]=function(t){t=decodeURIComponent(t),t=JSON.parse(t),delete window[e.callBack]},$DT2017.apiBridge.sendMessageToNative(e.apiName,JSON.stringify(e))},unselectAllElement:function(e){console.log("--> unselectAllElement!",e);for(var t=0;t<e.targetElement.length;t++)e.targetElement[t].style.backgroundImage="url(./images/view/view_SelectedIcon_off.png)",e.targetElement[t].setAttribute("isSelected",!1);this.selectedBookList=[]},removeBarrierElement:function(){for(var e=$alt.qsa(".barrierElement"),t=0;t<e.length;t++)e[t].parentElement.removeChild(e[t])}};return e}();